<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breathing Box Widget</title>
    <style>
        :root {
            --bg-color: #f0f4f8;
            --container-bg: white;
            --text-main: #333;
            --text-sub: #555;
            --text-muted: #888;
            --accent-btn: #333;
            --accent-btn-text: white;
            --shadow: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-main: #f0f0f0;
            --text-sub: #ccc;
            --text-muted: #aaa;
            --accent-btn: #f0f0f0;
            --accent-btn-text: #333;
            --shadow: rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .top-bar {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .widget-container {
            background: var(--container-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 25px var(--shadow);
            text-align: center;
            width: 450px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .technique-selector {
            margin-bottom: 20px;
        }

        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--text-muted);
            font-size: 1rem;
            background-color: var(--bg-color);
            color: var(--text-main);
            width: 100%;
            margin-bottom: 10px;
        }

        canvas {
            display: block;
            margin: 0 auto;
        }

        .status-text {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 15px;
            color: var(--text-sub);
            min-height: 2rem;
        }
        
        .timer-text {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 20px;
            min-height: 1.2rem;
        }

        .controls {
            margin-top: 20px;
            border-top: 1px solid var(--text-muted);
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }
        
        button {
            padding: 10px 30px;
            background-color: var(--accent-btn);
            color: var(--accent-btn-text);
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }
        
        button.stop {
            background-color: #e74c3c;
            color: white;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .session-info {
            font-size: 0.9rem;
            color: var(--text-sub);
            background: var(--bg-color);
            padding: 5px 15px;
            border-radius: 15px;
            display: none; 
            margin-bottom: 15px;
        }

        .legend {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        /* Toggle Switch */
        .theme-switch {
            background: none;
            border: 1px solid var(--text-main);
            color: var(--text-main);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="top-bar">
    <button class="theme-switch" onclick="toggleTheme()">Dark Mode</button>
</div>

<div class="widget-container">
    <div class="technique-selector">
        <select id="techniqueSelect" onchange="changeTechnique()">
            <option value="478">4-7-8 (Deep Relaxation)</option>
            <option value="box">Box Breathing (Focus)</option>
            <option value="333">3-3-3 (Calming Triangle)</option>
        </select>
    </div>

    <div class="session-info" id="overallTimer">Time Remaining: 00:00</div>
    
    <canvas id="breathCanvas" width="400" height="400"></canvas>
    
    <div class="status-text" id="statusText">Ready?</div>
    <div class="timer-text" id="phaseTimerText"></div>
    
    <div class="controls">
        <div class="input-group" id="startControls">
            <select id="minuteSelect">
                <option value="1">1 Minute</option>
                <option value="2">2 Minutes</option>
                <option value="3">3 Minutes</option>
                <option value="4">4 Minutes</option>
                <option value="5">5 Minutes</option>
            </select>
            <button onclick="startSession()" id="actionBtn">Start</button>
        </div>
        
        <button onclick="stopSession()" id="stopBtn" class="stop" style="display:none;">End Session</button>

        <div class="legend" id="legend">
            </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('breathCanvas');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('statusText');
    const phaseTimerDiv = document.getElementById('phaseTimerText');
    const overallTimerDiv = document.getElementById('overallTimer');
    const startControls = document.getElementById('startControls');
    const stopBtn = document.getElementById('stopBtn');
    const techniqueSelect = document.getElementById('techniqueSelect');
    const legendDiv = document.getElementById('legend');

    // --- Configuration ---
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const minSize = 100;
    const maxSize = 250;
    
    // Techniques Dictionary
    const techniques = {
        '478': {
            phases: [
                { name: 'inhale', duration: 4, label: "Breathe In...", color: '#77dd77' }, // Green
                { name: 'hold', duration: 7, label: "Hold...", color: '#89CFF0' },         // Blue
                { name: 'exhale', duration: 8, label: "Exhale Slowly...", color: '#b39eb5' } // Purple
            ]
        },
        'box': {
            phases: [
                { name: 'inhale', duration: 4, label: "Breathe In...", color: '#77dd77' },
                { name: 'hold', duration: 4, label: "Hold...", color: '#89CFF0' },
                { name: 'exhale', duration: 4, label: "Breathe Out...", color: '#b39eb5' },
                { name: 'hold_empty', duration: 4, label: "Rest...", color: '#FFB347' }    // Orange
            ]
        },
        '333': {
            phases: [
                { name: 'inhale', duration: 3, label: "Breathe In...", color: '#77dd77' },
                { name: 'hold', duration: 3, label: "Hold...", color: '#89CFF0' },
                { name: 'exhale', duration: 3, label: "Breathe Out...", color: '#b39eb5' }
            ]
        }
    };

    let currentTechKey = '478';
    let currentPhases = techniques['478'].phases;

    // State Variables
    let isRunning = false;
    let startTime = null;
    let sessionEndTime = null;
    let animationFrameId = null;

    // --- Logic ---

    function changeTechnique() {
        if(isRunning) stopSession();
        currentTechKey = techniqueSelect.value;
        currentPhases = techniques[currentTechKey].phases;
        updateLegend();
        drawIdle();
    }

    function updateLegend() {
        legendDiv.innerHTML = '';
        currentPhases.forEach(phase => {
            const span = document.createElement('span');
            span.innerHTML = `<span class="dot" style="background:${phase.color};"></span>${phase.name.charAt(0).toUpperCase() + phase.name.slice(1)}`;
            legendDiv.appendChild(span);
        });
    }

    function drawIdle() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-muted').trim();
        const x = centerX - (minSize / 2);
        const y = centerY - (minSize / 2);
        
        ctx.beginPath();
        if (ctx.roundRect) ctx.roundRect(x, y, minSize, minSize, 30);
        else ctx.rect(x, y, minSize, minSize);
        ctx.fill();
        
        statusDiv.innerText = "Ready?";
        phaseTimerDiv.innerText = "";
    }

    function startSession() {
        const minutes = parseInt(document.getElementById('minuteSelect').value);
        const durationMs = minutes * 60 * 1000;
        
        isRunning = true;
        startTime = performance.now();
        sessionEndTime = startTime + durationMs;
        
        startControls.style.display = 'none';
        stopBtn.style.display = 'block';
        overallTimerDiv.style.display = 'inline-block';
        techniqueSelect.disabled = true;
        
        requestAnimationFrame(loop);
    }

    function stopSession(finishedNaturally = false) {
        isRunning = false;
        cancelAnimationFrame(animationFrameId);
        
        startControls.style.display = 'flex';
        stopBtn.style.display = 'none';
        overallTimerDiv.style.display = 'none';
        techniqueSelect.disabled = false;
        
        statusDiv.innerText = finishedNaturally ? "Session Complete" : "Stopped";
        statusDiv.style.color = "var(--text-main)";
        phaseTimerDiv.innerText = finishedNaturally ? "Great job!" : "";
        
        drawIdle();
    }

    function loop(currentTime) {
        if (!isRunning) return;

        if (currentTime >= sessionEndTime) {
            stopSession(true);
            return;
        }

        const msRemaining = sessionEndTime - currentTime;
        const totalSecondsRemaining = Math.ceil(msRemaining / 1000);
        const mins = Math.floor(totalSecondsRemaining / 60);
        const secs = totalSecondsRemaining % 60;
        overallTimerDiv.innerText = `Time Remaining: ${mins}:${secs < 10 ? '0' : ''}${secs}`;

        const totalCycleDuration = currentPhases.reduce((acc, phase) => acc + (phase.duration * 1000), 0);
        const elapsedTime = (currentTime - startTime) % totalCycleDuration;
        
        let timeAccumulator = 0;
        let activePhase = null;
        let timeInPhase = 0;

        for (let phase of currentPhases) {
            let phaseDurationMs = phase.duration * 1000;
            if (elapsedTime < timeAccumulator + phaseDurationMs) {
                activePhase = phase;
                timeInPhase = elapsedTime - timeAccumulator;
                break;
            }
            timeAccumulator += phaseDurationMs;
        }

        let size = minSize;
        
        if (activePhase.name === 'inhale') {
            const progress = timeInPhase / (activePhase.duration * 1000);
            size = minSize + (maxSize - minSize) * Math.sin(progress * (Math.PI/2));
            
        } else if (activePhase.name === 'hold') {
            size = maxSize + (Math.sin(timeInPhase * 0.005) * 5);
            
        } else if (activePhase.name === 'exhale') {
            const progress = timeInPhase / (activePhase.duration * 1000);
            size = maxSize - (maxSize - minSize) * progress;
            
        } else if (activePhase.name === 'hold_empty') {
            size = minSize + (Math.sin(timeInPhase * 0.005) * 3);
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = activePhase.color;
        
        const x = centerX - (size / 2);
        const y = centerY - (size / 2);
        
        ctx.beginPath();
        if (ctx.roundRect) ctx.roundRect(x, y, size, size, 40);
        else ctx.rect(x, y, size, size);
        ctx.fill();

        statusDiv.innerText = activePhase.label;
        statusDiv.style.color = activePhase.color;
        phaseTimerDiv.innerText = Math.ceil(activePhase.duration - (timeInPhase/1000)) + "s";

        animationFrameId = requestAnimationFrame(loop);
    }

    function toggleTheme() {
        const body = document.body;
        const currentTheme = body.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', newTheme);
        if(!isRunning) drawIdle();
    }

    updateLegend();
    drawIdle();

</script>

</body>
</html>
