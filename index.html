<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Just Breathe</title>
    <style>
        :root {
            --bg-color: #f0f4f8;
            --container-bg: white;
            --text-main: #333;
            --text-sub: #555;
            --text-muted: #888;
            --shadow: rgba(0,0,0,0.1);
            --toggle-border: #ddd;
            
            /* Phase Colors */
            --color-inhale: #77dd77;
            --color-hold: #89CFF0;
            --color-exhale: #b39eb5;
            --color-rest: #FFB347;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-main: #f0f0f0;
            --text-sub: #ccc;
            --text-muted: #aaa;
            --shadow: rgba(0,0,0,0.3);
            --toggle-border: #555;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
            /* LOCK THE VIEWPORT */
            height: 100dvh; /* Dynamic Viewport Height handles mobile browser bars */
            overflow: hidden; /* Ban scrolling entirely */
            display: flex;
            flex-direction: column;
            align-items: center;
            /* nav.js adds ~60px top padding, we center in the REMAINING space */
            justify-content: center; 
            box-sizing: border-box;
        }

        .widget-container {
            position: relative;
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 10px 25px var(--shadow);
            text-align: center;
            
            width: 95%;
            max-width: 480px;
            
            /* CALCULATE EXACT HEIGHT TO FIT SCREEN MINUS NAV */
            /* 100dvh - 80px (approx Nav height + margin) */
            max-height: calc(100dvh - 80px);
            
            /* Vertical Flex Layout */
            display: flex;
            flex-direction: column;
            justify-content: space-evenly; /* Distribute vertical space evenly */
            padding: 15px; /* Minimal padding */
            box-sizing: border-box;
            
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* --- TITLE STYLE (Compact) --- */
        .app-title {
            margin: 0;
            font-size: 1.4rem; /* Smaller for mobile */
            font-weight: 800;
            letter-spacing: 1px;
            color: var(--text-main);
            text-transform: uppercase;
            line-height: 1.2;
        }

        /* Toggle Switch */
        .theme-switch {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: 1px solid var(--toggle-border);
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.65rem;
            cursor: pointer;
            z-index: 10;
        }

        /* Tech Buttons (Compact) */
        .tech-buttons {
            display: flex;
            gap: 5px;
            width: 100%;
            margin: 10px 0;
        }

        .tech-btn {
            flex: 1;
            padding: 8px 2px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            opacity: 0.6;
            transform: scale(0.98);
        }

        .tech-btn.active { opacity: 1; transform: scale(1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-478 { background-color: var(--color-inhale); } 
        .btn-box { background-color: var(--color-rest); } 
        .btn-333 { background-color: var(--color-exhale); } 

        /* Canvas Responsive Fix */
        canvas {
            display: block;
            margin: 0 auto;
            width: auto;
            
            /* THE KEY FIX: */
            /* Allow canvas to shrink if screen is small, but cap it at 35% of screen height */
            max-height: 35vh; 
            max-width: 100%;
            object-fit: contain;
            flex-shrink: 1; /* Allow this element to shrink if needed */
        }

        .status-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-sub);
            margin: 5px 0;
        }
        
        .timer-text {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 5px;
            min-height: 1.1rem;
        }

        .controls {
            border-top: 1px solid var(--text-muted);
            padding-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .input-group {
            display: flex;
            gap: 5px;
            width: 100%;
        }

        select {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--text-muted);
            font-size: 0.9rem;
            background-color: var(--bg-color);
            color: var(--text-main);
            flex-grow: 1;
        }
        
        .action-btn {
            padding: 8px 15px;
            background-color: var(--text-main);
            color: var(--container-bg);
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .action-btn.stop {
            background-color: #e74c3c;
            color: white;
            width: 100%;
        }
        
        .session-info {
            font-size: 0.8rem;
            color: var(--text-sub);
            background: var(--bg-color);
            padding: 3px 10px;
            border-radius: 10px;
            display: none; 
            margin-bottom: 5px;
        }

        .legend {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .dot { height: 6px; width: 6px; border-radius: 50%; display: inline-block; margin-right: 3px; }
    </style>
</head>
<body>

<div class="widget-container">
    
    
    <h1 class="app-title">JUST BREATHE</h1>

    <div class="tech-buttons">
        <button class="tech-btn btn-478 active" id="btn-478" onclick="selectTechnique('478')">4-7-8 Relax</button>
        <button class="tech-btn btn-box" id="btn-box" onclick="selectTechnique('box')">Box Focus</button>
        <button class="tech-btn btn-333" id="btn-333" onclick="selectTechnique('333')">3-3-3 Calm</button>
    </div>

    <div class="session-info" id="overallTimer">Time Remaining: 00:00</div>
    
    <canvas id="breathCanvas" width="350" height="350"></canvas>
    
    <div class="status-text" id="statusText">Ready?</div>
    <div class="timer-text" id="phaseTimerText"></div>
    
    <div class="controls">
        <div class="input-group" id="startControls">
            <select id="minuteSelect">
                <option value="1">1 Minute</option>
                <option value="2">2 Minutes</option>
                <option value="3">3 Minutes</option>
                <option value="4">4 Minutes</option>
                <option value="5">5 Minutes</option>
            </select>
            <button onclick="startSession()" id="actionBtn" class="action-btn">Start</button>
        </div>
        
        <button onclick="stopSession()" id="stopBtn" class="action-btn stop" style="display:none;">End Session</button>

        <div class="legend" id="legend"></div>
    </div>
</div>

<script src="nav.js"></script>
<script>
    const canvas = document.getElementById('breathCanvas');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('statusText');
    const phaseTimerDiv = document.getElementById('phaseTimerText');
    const overallTimerDiv = document.getElementById('overallTimer');
    const startControls = document.getElementById('startControls');
    const stopBtn = document.getElementById('stopBtn');
    const legendDiv = document.getElementById('legend');
    const techButtons = document.querySelectorAll('.tech-btn');

    // Canvas sizing setup
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const minSize = 80;
    const maxSize = 220;
    
    const techniques = {
        '478': {
            phases: [
                { name: 'inhale', duration: 4, label: "Breathe In...", color: '#77dd77' },
                { name: 'hold', duration: 7, label: "Hold...", color: '#89CFF0' },
                { name: 'exhale', duration: 8, label: "Exhale Slowly...", color: '#b39eb5' }
            ]
        },
        'box': {
            phases: [
                { name: 'inhale', duration: 4, label: "Breathe In...", color: '#77dd77' },
                { name: 'hold', duration: 4, label: "Hold...", color: '#89CFF0' },
                { name: 'exhale', duration: 4, label: "Breathe Out...", color: '#b39eb5' },
                { name: 'hold_empty', duration: 4, label: "Rest...", color: '#FFB347' }
            ]
        },
        '333': {
            phases: [
                { name: 'inhale', duration: 3, label: "Breathe In...", color: '#77dd77' },
                { name: 'hold', duration: 3, label: "Hold...", color: '#89CFF0' },
                { name: 'exhale', duration: 3, label: "Breathe Out...", color: '#b39eb5' }
            ]
        }
    };

    let currentTechKey = '478';
    let currentPhases = techniques['478'].phases;
    let isRunning = false;
    let startTime = null;
    let sessionEndTime = null;
    let animationFrameId = null;

    function selectTechnique(key) {
        if(isRunning) stopSession();
        currentTechKey = key;
        currentPhases = techniques[key].phases;
        techButtons.forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${key}`).classList.add('active');
        updateLegend();
        drawIdle();
    }

    function updateLegend() {
        legendDiv.innerHTML = '';
        currentPhases.forEach(phase => {
            const span = document.createElement('span');
            span.innerHTML = `<span class="dot" style="background:${phase.color};"></span>${phase.name.charAt(0).toUpperCase() + phase.name.slice(1)}`;
            legendDiv.appendChild(span);
        });
    }

    function drawIdle() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-muted').trim();
        const x = centerX - (minSize / 2);
        const y = centerY - (minSize / 2);
        
        ctx.beginPath();
        if (ctx.roundRect) ctx.roundRect(x, y, minSize, minSize, 30);
        else ctx.rect(x, y, minSize, minSize);
        ctx.fill();
        statusDiv.innerText = "Ready?";
        phaseTimerDiv.innerText = "";
    }

    function startSession() {
        const minutes = parseInt(document.getElementById('minuteSelect').value);
        const durationMs = minutes * 60 * 1000;
        isRunning = true;
        startTime = performance.now();
        sessionEndTime = startTime + durationMs;
        startControls.style.display = 'none';
        stopBtn.style.display = 'block';
        overallTimerDiv.style.display = 'inline-block';
        techButtons.forEach(btn => btn.disabled = true);
        requestAnimationFrame(loop);
    }

    function stopSession(finishedNaturally = false) {
        isRunning = false;
        cancelAnimationFrame(animationFrameId);
        startControls.style.display = 'flex';
        stopBtn.style.display = 'none';
        overallTimerDiv.style.display = 'none';
        techButtons.forEach(btn => btn.disabled = false);
        statusDiv.innerText = finishedNaturally ? "Session Complete" : "Stopped";
        statusDiv.style.color = "var(--text-main)";
        phaseTimerDiv.innerText = finishedNaturally ? "Great job!" : "";
        drawIdle();
    }

    function loop(currentTime) {
        if (!isRunning) return;
        if (currentTime >= sessionEndTime) { stopSession(true); return; }

        const msRemaining = sessionEndTime - currentTime;
        const totalSecondsRemaining = Math.ceil(msRemaining / 1000);
        const mins = Math.floor(totalSecondsRemaining / 60);
        const secs = totalSecondsRemaining % 60;
        overallTimerDiv.innerText = `Time Remaining: ${mins}:${secs < 10 ? '0' : ''}${secs}`;

        const totalCycleDuration = currentPhases.reduce((acc, phase) => acc + (phase.duration * 1000), 0);
        const elapsedTime = (currentTime - startTime) % totalCycleDuration;
        
        let timeAccumulator = 0;
        let activePhase = null;
        let timeInPhase = 0;

        for (let phase of currentPhases) {
            let phaseDurationMs = phase.duration * 1000;
            if (elapsedTime < timeAccumulator + phaseDurationMs) {
                activePhase = phase;
                timeInPhase = elapsedTime - timeAccumulator;
                break;
            }
            timeAccumulator += phaseDurationMs;
        }

        let size = minSize;
        if (activePhase.name === 'inhale') {
            const progress = timeInPhase / (activePhase.duration * 1000);
            size = minSize + (maxSize - minSize) * Math.sin(progress * (Math.PI/2));
        } else if (activePhase.name === 'hold') {
            size = maxSize + (Math.sin(timeInPhase * 0.005) * 5);
        } else if (activePhase.name === 'exhale') {
            const progress = timeInPhase / (activePhase.duration * 1000);
            size = maxSize - (maxSize - minSize) * progress;
        } else if (activePhase.name === 'hold_empty') {
            size = minSize + (Math.sin(timeInPhase * 0.005) * 3);
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = activePhase.color;
        const x = centerX - (size / 2);
        const y = centerY - (size / 2);
        ctx.beginPath();
        if (ctx.roundRect) ctx.roundRect(x, y, size, size, 40);
        else ctx.rect(x, y, size, size);
        ctx.fill();

        // Draw Progress Border during Hold phases
        if (activePhase.name.includes('hold')) {
            const progress = timeInPhase / (activePhase.duration * 1000);
            // Approximate perimeter for dash offset: 4 * size (rect) or adjusted for rounded corners
            // RoundRect perimeter approx: 2(w+h) - 8r + 2*PI*r. Here w=h=size, r=40.
            const perimeter = ctx.roundRect ? (4 * size - 8 * 40 + 2 * Math.PI * 40) : (4 * size);
            
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--text-main').trim();
            ctx.lineWidth = 4;
            ctx.setLineDash([perimeter * progress, perimeter]);
            ctx.stroke();
            ctx.setLineDash([]); // Reset
        }

        statusDiv.innerText = activePhase.label;
        statusDiv.style.color = activePhase.color;
        phaseTimerDiv.innerText = Math.ceil(activePhase.duration - (timeInPhase/1000)) + "s";
        animationFrameId = requestAnimationFrame(loop);
    }

    function toggleTheme() {
        const body = document.body;
        const currentTheme = body.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', newTheme);
        if(!isRunning) drawIdle();
    }

    updateLegend();
    drawIdle();
</script>

</body>
</html>
